<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trim Tracker</title>
  <style>
    /* (Same CSS as you provided) */
    body {
      background-color: #111;
      color: #fff;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      text-align: center;
    }
    .lang-toggle {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: #333;
      color: #fff;
      border: 1px solid #777;
      padding: 6px 10px;
      cursor: pointer;
    }
    img.banner {
      width: 100%;
      max-width: 800px;
      margin-bottom: 30px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      font-size: 16px;
      line-height: 1.5;
      font-weight: bold;
    }
    th, td {
      border: 1px solid #444;
      padding: 12px;
      text-align: center;
      transition: background-color 0.2s ease;
      font-weight: bold;
    }
    tbody tr:nth-child(even) {
      background-color: #1a1a1a;
    }
    tbody tr:hover {
      background-color: #2a2a2a;
    }
    input[type="text"], input[type="number"], input[type="date"] {
      width: 100%;
      padding: 6px;
      font-size: 16px;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      font-weight: bold;
      box-sizing: border-box;
      background-color: #222;
      color: #fff;
      border: 1px solid #555;
    }
    button {
      padding: 8px 12px;
      margin: 10px 5px;
      background-color: #28a745;
      border: none;
      color: white;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background-color: #218838;
    }
    button.delete-row {
      background-color: #dc3545;
    }
    button.delete-row:hover {
      background-color: #c82333;
    }
    button.clear-all {
      background-color: #ffc107;
      color: #111;
    }
    button.clear-all:hover {
      background-color: #e0a800;
    }
    a.back-link {
      display: inline-block;
      margin-top: 30px;
      color: #0af;
      text-decoration: none;
    }
  </style>
</head>
<body>

  <button class="lang-toggle" onclick="toggleLanguage()">Español</button>
  <img src="trim-tracker-banner.PNG" alt="Trim Tracker Banner" class="banner" />

  <p style="color: #ccc; max-width: 700px; margin: 0 auto 20px;">
    <strong>Note:</strong> Your data is saved locally in your browser and will remain available unless you clear your cache or switch devices or browsers. While this tool helps track data, we recommend backing up your info separately to avoid data loss.
  </p>

  <table id="sessionTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Strain</th>
        <th>Grams</th>
        <th>Total</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <button onclick="addRow()">Add Row</button>
  <button class="clear-all" onclick="clearAllRows()">Clear All</button>
  <button onclick="exportCSV()">Export CSV</button>
  <a id="backLink" class="back-link">← Back to Trim Calculator</a>

  <div id="dailyTotals" style="margin-top: 30px; text-align: left; max-width: 800px; margin-left: auto; margin-right: auto;">
    <h3>Daily Totals</h3>
    <ul id="totalsList" style="list-style: none; padding: 0;"></ul>
  </div>

  <script>
    const lang = document.documentElement.lang;
    const storageKey = `trimTrackerData-${lang}`; // Language-specific storage

    let saveTimeout;

    function debounceSave() {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        if ('requestIdleCallback' in window) {
          requestIdleCallback(saveData);
        } else {
          saveData();
        }
      }, 300);
    }

    function createGramInput(onChangeFunc, value = '') {
      const input = document.createElement('input');
      input.type = 'number';
      input.min = '0';
      input.step = '0.01';
      input.placeholder = 'g';
      input.value = value;
      input.oninput = () => {
        onChangeFunc();
        debounceSave();
      };
      return input;
    }

    function addRow(data = {}) {
      const tbody = document.getElementById('tableBody');
      const row = document.createElement('tr');

      const dateCell = document.createElement('td');
      const dateInput = document.createElement('input');
      dateInput.type = 'date';
      dateInput.value = data.date || '';
      dateInput.oninput = () => { debounceSave(); updateDailyTotals(); };
      dateCell.appendChild(dateInput);
      row.appendChild(dateCell);

      const strainCell = document.createElement('td');
      const strainInput = document.createElement('input');
      strainInput.type = 'text';
      strainInput.value = data.strain || '';
      strainInput.oninput = debounceSave;
      strainCell.appendChild(strainInput);
      row.appendChild(strainCell);

      const gramsCell = document.createElement('td');
      const gramsWrapper = document.createElement('div');
      gramsWrapper.style.display = 'flex';
      gramsWrapper.style.flexWrap = 'wrap';
      gramsWrapper.style.gap = '4px';

      const totalCell = document.createElement('td');

      const updateTotal = () => {
        const inputs = gramsWrapper.querySelectorAll('input');
        let sum = 0;
        inputs.forEach(input => {
          const val = parseFloat(input.value);
          if (!isNaN(val)) sum += val;
        });
        totalCell.innerText = sum.toFixed(2);
        updateDailyTotals();
      };

      (data.grams || ['', '', '']).forEach(g => {
        gramsWrapper.appendChild(createGramInput(updateTotal, g));
      });

      const addGramBtn = document.createElement('button');
      addGramBtn.textContent = '+';
      addGramBtn.onclick = () => {
        gramsWrapper.appendChild(createGramInput(updateTotal));
        debounceSave();
      };

      gramsCell.appendChild(gramsWrapper);
      gramsCell.appendChild(addGramBtn);
      row.appendChild(gramsCell);

      totalCell.innerText = '0.00';
      row.appendChild(totalCell);
      updateTotal();

      const actionCell = document.createElement('td');
      const delBtn = document.createElement('button');
      delBtn.textContent = 'Delete';
      delBtn.className = 'delete-row';
      delBtn.onclick = () => {
        if (confirm('Are you sure you want to delete this row?')) {
          row.remove();
          debounceSave();
          updateDailyTotals();
        }
      };
      actionCell.appendChild(delBtn);
      row.appendChild(actionCell);

      tbody.appendChild(row);
    }

    function clearAllRows() {
      if (confirm('Are you sure you want to clear all rows? This cannot be undone.')) {
        document.getElementById('tableBody').innerHTML = '';
        addRow();
        debounceSave();
        updateDailyTotals();
      }
    }

    function saveData() {
      const rows = document.querySelectorAll('#tableBody tr');
      const data = Array.from(rows).map(row => {
        const [dateCell, strainCell, gramsCell] = row.querySelectorAll('td');
        const date = dateCell.querySelector('input').value;
        const strain = strainCell.querySelector('input').value;
        const grams = Array.from(gramsCell.querySelectorAll('input')).map(input => input.value);
        return { date, strain, grams };
      });
      localStorage.setItem(storageKey, JSON.stringify(data));
    }

    function loadData() {
      const stored = localStorage.getItem(storageKey);
      if (stored) {
        const parsed = JSON.parse(stored);
        parsed.forEach(entry => addRow(entry));
      } else {
        addRow();
      }
    }

    function exportCSV() {
      const rows = document.querySelectorAll('#tableBody tr');
      let csvContent = "Date,Strain,Grams (semicolon-separated),Total\n";

      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const date = cells[0].querySelector('input').value;
        const strain = cells[1].querySelector('input').value;
        const gramInputs = cells[2].querySelectorAll('input');
        const grams = Array.from(gramInputs).map(input => input.value).join(';');
        const total = cells[3].innerText;
        csvContent += `"${date}","${strain}","${grams}","${total}"\n`;
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', 'trim-tracker.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function updateDailyTotals() {
      const rows = document.querySelectorAll('#tableBody tr');
      const totalsMap = {};

      rows.forEach(row => {
        const date = row.querySelector('td input[type="date"]').value;
        const total = parseFloat(row.querySelector('td:nth-child(4)').innerText) || 0;
        if (date) {
          if (!totalsMap[date]) totalsMap[date] = 0;
          totalsMap[date] += total;
        }
      });

      const totalsList = document.getElementById('totalsList');
      totalsList.innerHTML = '';

      Object.entries(totalsMap).forEach(([date, total]) => {
        const li = document.createElement('li');
        li.textContent = `${date}: ${total.toFixed(2)}g`;
        totalsList.appendChild(li);
      });
    }

    function toggleLanguage() {
      const currentLang = document.documentElement.lang;
      const newLang = currentLang === 'en' ? 'es' : 'en';
      const newPage = newLang === 'en' ? 'trim-tracker.html' : 'trim-tracker-es.html';
      window.location.href = newPage;
    }

    document.getElementById('backLink').href = lang === 'es' ? 'index-es.html' : 'index.html';

    loadData();
  </script>
</body>
</html>
